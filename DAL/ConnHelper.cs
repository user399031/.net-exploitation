using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.Data.OleDb;
using System.Data.SqlClient;
using System.Configuration;

namespace DAL
{
    public class ConnHelper
    {
        private static string connectionString = ConfigurationManager.ConnectionStrings["myConn"].ConnectionString;
        public static DataTable getDT(string strSQL)
        {
            SqlConnection conn = new SqlConnection(connectionString);
            conn.Open();

            SqlDataAdapter da = new SqlDataAdapter(strSQL, conn);
            DataTable dt = new DataTable();
            da.Fill(dt);
            conn.Close();
            return dt;
        }
        //public static List<string> GetDistinceColoum(string strSQL, string str1)
        //{
        //    DataTable dt = GetDataTable(strSQL);
        //    List<string> strList = new List<string>();
        //    foreach (DataRow dr in dt.Rows)
        //    {
        //        string str = dr[str1].ToString();
        //        strList.Add(str);
        //    }
        //    return strList;
        //}
        //public static DataTable GetDistinceColoum(string strSQL)
        string currFilepath = string.Empty;//DLL层的两个全局变量
        string currFileExtension = string.Empty;
        //1。传进来地址和excel里表的名字
        public DataTable LoadExcel(string path,string tabelname)
        {
            //Label1.Text = FileUpload1.PostedFile.FileName;
            string strConn = "provider=microsoft.jet.oledb.4.0;data source='" + path + "';Extended Properties=Excel 8.0";
            OleDbConnection conn = new OleDbConnection(strConn);
            conn.Open();
            string strSQL = "select * from ["+tabelname+"$]";
            DataTable dt = new DataTable();
            OleDbDataAdapter da = new OleDbDataAdapter(strSQL, conn);
            da.Fill(dt);

            conn.Close();
            return dt;
        }
        public void Upload(HttpPostedFile fname)//参数是从UI层得到的feilupload的路径
        {
            string tim = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss fff").Replace(":", " ");
            HttpPostedFile file =fname;
            string fileName = file.FileName;
            string tempPath = System.IO.Path.GetTempPath();
            //string tempPath = Server.MapPath("./") + "ddd\\";这里帮我改一下，我一直用的默认位置，你改成指定位置
            fileName = System.IO.Path.GetFileName(fileName);
            this.currFileExtension = System.IO.Path.GetExtension(fileName);
            this.currFilepath = tempPath + tim + " " + fileName;
            file.SaveAs(this.currFilepath);
        }
        public string GETPath()//返回服务器文件路径
        {
            return currFilepath;
        }
        //private static string connectionString = ConfigurationManager.ConnectionStrings["myConn"].ConnectionString;
        public static void AddData2Databass(string strSQL)//增删改的方法，暂时用不到
        {
            SqlConnection conn = new SqlConnection(connectionString);
            conn.Open();

            SqlCommand cmd = new SqlCommand(strSQL, conn);
            cmd.ExecuteNonQuery();
            conn.Close();
        }
        public static void SQLBulkCopy(DataTable dt, string DBname)//录入各系部的方法，因为表格式一样都用这个方法
        {
            //string connectionString = ConfigurationManager.ConnectionStrings["myConn"].ConnectionString;
            SqlConnection conn = new SqlConnection(connectionString);
            conn.Open();
            using (SqlBulkCopy bulkCopy = new SqlBulkCopy(conn))
            {
                bulkCopy.DestinationTableName = DBname;
                bulkCopy.WriteToServer(dt);

            }
        }
        public static void SQLBulkCopyFortcher(DataTable dt, string DBname)//录入老师信息的方法
        {
            SqlConnection conn = new SqlConnection(connectionString);
            conn.Open();
            using (SqlBulkCopy bulkCopy = new SqlBulkCopy(conn))
            {
                bulkCopy.DestinationTableName = DBname;
                bulkCopy.ColumnMappings.Add("部门", "Department");
                bulkCopy.ColumnMappings.Add("工号", "UserID");
                bulkCopy.ColumnMappings.Add("密码", "UserPWD");
                bulkCopy.ColumnMappings.Add("姓名", "UserName");
                bulkCopy.ColumnMappings.Add("性别", "Sex");
                bulkCopy.ColumnMappings.Add("权限", "Role");
                bulkCopy.WriteToServer(dt);
            }
        }
    }
}
}
